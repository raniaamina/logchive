<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SaveLog Manager</title>
<style>
  /* Reset & basic */
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: Arial, sans-serif;
    display: flex; flex-direction: column;
  }

  /* Header login selalu di atas */
  header {
    background: #333;
    color: white;
    padding: 1em;
    display: flex;
    align-items: center;
    justify-content: space-between; /* spasi kiri kanan */
    gap: 1em;
    position: sticky;
    top: 0; z-index: 10;
  }
  header input, header button {
    padding: 0.4em 0.6em;
    font-size: 1em;
  }
  header input {
    border: none;
    border-radius: 3px;
  }
  header button {
    background: #4caf50;
    border: none;
    color: white;
    cursor: pointer;
    border-radius: 3px;
  }
  header button:hover {
    background: #45a049;
  }

  #loginSection {
    display: flex;
    gap: 0.5em;
    align-items: center;
  }

  #cleanupBtn {
    background: #d9534f;
    border: none;
    color: white;
    cursor: pointer;
    padding: 0.5em 0.8em;
    border-radius: 3px;
    font-weight: bold;
  }
  #cleanupBtn:hover {
    background: #c9302c;
  }

  /* Konten utama flex container */
  main {
    flex: 1;
    display: flex;
    height: calc(100vh - 56px); /* tinggi viewport - header */
    overflow: hidden;
  }

  /* Sidebar kiri: daftar log + filter + tombol autoclean */
  #sidebar {
    width: 320px;
    border-right: 1px solid #ccc;
    display: flex;
    flex-direction: column;
  }

  #filterInput {
    padding: 0.5em;
    border: none;
    border-bottom: 1px solid #ccc;
    font-size: 1em;
  }

  #autoCleanBtn {
    background: #d9534f;
    color: white;
    border: none;
    padding: 0.5em;
    margin: 0.5em;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
  }
  #autoCleanBtn:hover {
    background: #c9302c;
  }

  #logsList {
    flex: 1;
    overflow-y: auto;
    padding: 0.5em;
  }

  /* Tombol log */
  #logsList button {
    width: 100%;
    text-align: left;
    padding: 0.6em 1em;
    margin: 0.25em 0;
    border: 2px solid #888;
    border-radius: 4px;
    background: #f9f9f9;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.2s, border-color 0.2s;
  }
  #logsList button:hover {
    background-color: #ddd;
  }

  /* Private log border merah */
  #logsList button.private {
    border-color: #d9534f; /* merah */
  }

  /* Tombol log aktif */
  #logsList button.active {
    background-color: #4caf50;
    color: white;
    border-color: #4caf50;
  }

  /* Preview isi log di kanan */
  #previewContainer {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 1em;
    background: #f0f0f0;
    font-family: monospace;
    font-size: 1em;
    overflow: hidden;
  }
  #logInfo {
    margin-bottom: 1em;
    background: white;
    padding: 0.5em 1em;
    border-radius: 6px;
    font-size: 0.9em;
    color: #333;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
  }
  #preview {
    flex: 1;
    overflow-y: auto;
    white-space: pre-wrap;
    background: white;
    padding: 1em;
    border-radius: 6px;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
  }

  /* Logout button */
  #logoutBtn {
    background: #d9534f;
    border: none;
    color: white;
    padding: 0.4em 0.8em;
    cursor: pointer;
    border-radius: 3px;
  }
  #logoutBtn:hover {
    background: #c9302c;
  }
</style>
</head>
<body>

<header>
  <div id="loginSection">
    <form id="loginForm" style="display:flex; gap:0.5em; align-items:center;">
      <input type="text" id="username" placeholder="Username" required />
      <input type="password" id="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
    <button id="logoutBtn" style="display:none;">Logout</button>
  </div>
  <button id="cleanupBtn" title="Hapus semua log yang filenya hilang">Clear Missing Logs</button>
</header>

<main>
  <div id="sidebar">
    <input type="text" id="filterInput" placeholder="Filter nama log..." />
    <button id="autoCleanBtn" title="Hapus log yang sudah expired">Autoclean Expired Logs</button>
    <div id="logsList">Memuat log...</div>
  </div>
  <div id="previewContainer">
    <div id="logInfo">Pilih log untuk melihat info dan isinya.</div>
    <pre id="preview"></pre>
  </div>
</main>

<script>
const API_URL = "http://localhost:8077";
let token = null;
let allLogs = [];
let filteredLogs = [];
let activeLogId = null;

function formatDate(dateStr) {
  if (!dateStr) return "-";
  const d = new Date(dateStr);
  return d.toLocaleString();
}

// Fetch log publik dan user privat (kalau login)
async function fetchLogs() {
  try {
    // Fetch publik
    const publicResp = await fetch(`${API_URL}/logs_public`);
    const publicLogs = publicResp.ok ? await publicResp.json() : [];

    if (token) {
      // Fetch privat
      const privateResp = await fetch(`${API_URL}/logs`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const privateLogs = privateResp.ok ? await privateResp.json() : [];
      // Gabungkan & tandai private
      allLogs = [...privateLogs.map(l => ({...l, private: true})), ...publicLogs.map(l => ({...l, private: false}))];
    } else {
      allLogs = publicLogs.map(l => ({...l, private: false}));
    }
    applyFilter();
  } catch(e) {
    document.getElementById("logsList").innerText = "Gagal memuat log.";
  }
}

function applyFilter() {
  const filterText = document.getElementById("filterInput").value.toLowerCase();
  filteredLogs = allLogs.filter(l => (l.filename || "").toLowerCase().includes(filterText));
  renderLogs();
}

function renderLogs() {
  const container = document.getElementById("logsList");
  container.innerHTML = "";
  if (filteredLogs.length === 0) {
    container.innerHTML = "<i>Tidak ada log yang sesuai filter.</i>";
    return;
  }
  filteredLogs.forEach(log => {
    const btn = document.createElement("button");
    btn.textContent = log.filename || `Log #${log.id}`;
    btn.className = log.private ? "private" : "";
    if (log.id === activeLogId) btn.classList.add("active");
    btn.onclick = () => selectLog(log);
    container.appendChild(btn);
  });
}

async function selectLog(log) {
  activeLogId = log.id;
  renderLogs();

  // Tampilkan info di atas preview
  let infoHtml = `
    <b>Nama File:</b> ${log.filename || "-"}<br/>
    <b>Dibuat:</b> ${formatDate(log.created_at)}<br/>
    <b>Owner:</b> ${log.owner_id ? "User ID " + log.owner_id : "Anonymous"}<br/>
    <b>Expired:</b> ${formatDate(log.expire_at)}
  `;
  document.getElementById("logInfo").innerHTML = infoHtml;

  // Jika sudah ada content, pakai langsung
  if (log.content) {
    showPreview(log.content);
    return;
  }

  // Ambil isi log sesuai tipe (private atau public)
  if (!log.private) {
    const resp = await fetch(`${API_URL}/logs/${encodeURIComponent(log.filename)}`);
    if (resp.ok) {
      const text = await resp.text();
      showPreview(text);
    } else {
      showPreview("Gagal memuat isi log.");
    }
  } else {
    if (!token) {
      alert("Harap login untuk melihat log privat.");
      return;
    }
    const resp = await fetch(`${API_URL}/logs/${log.id}`, {
      headers: { "Authorization": `Bearer ${token}` }
    });
    if (resp.ok) {
      const data = await resp.json();
      showPreview(data.content);
    } else {
      showPreview("Gagal memuat isi log privat.");
    }
  }
}

function showPreview(text) {
  document.getElementById("preview").textContent = text;
}

// Tombol Autoclean handler
document.getElementById("autoCleanBtn").addEventListener("click", async () => {
  if (!confirm("Yakin ingin menghapus semua log yang sudah expired?")) return;
  try {
    const resp = await fetch(`${API_URL}/autodelete`, {
      method: "DELETE",
      headers: token ? { "Authorization": `Bearer ${token}` } : {}
    });
    if (resp.ok) {
      const result = await resp.json();
      alert(result.msg);
      fetchLogs();
      document.getElementById("logInfo").textContent = "Pilih log untuk melihat info dan isinya.";
      document.getElementById("preview").textContent = "";
    } else {
      alert("Gagal melakukan autoclean.");
    }
  } catch {
    alert("Kesalahan saat melakukan autoclean.");
  }
});

// Tombol Clear Missing Logs handler
document.getElementById("cleanupBtn").addEventListener("click", async () => {
  if (!token) {
    alert("Harap login untuk menggunakan fitur Clear Missing Logs.");
    return;
  }
  if (!confirm("Yakin ingin menghapus semua log yang filenya hilang? Tindakan ini tidak dapat dibatalkan.")) return;

  try {
    const resp = await fetch(`${API_URL}/check_missing_files_all`, {
      method: "POST",
      headers: { "Authorization": `Bearer ${token}` }
    });
    if (resp.ok) {
      const result = await resp.json();
      alert(result.msg);
      // Reset state UI
      allLogs = [];
      filteredLogs = [];
      activeLogId = null;
      document.getElementById("logsList").innerHTML = "Memuat log...";
      document.getElementById("logInfo").textContent = "Pilih log untuk melihat info dan isinya.";
      document.getElementById("preview").textContent = "";
      fetchLogs();
    } else {
      alert("Gagal melakukan Clear Missing Logs.");
    }
  } catch {
    alert("Kesalahan saat melakukan Clear Missing Logs.");
  }
});

// Login form handler
document.getElementById("loginForm").addEventListener("submit", async e => {
  e.preventDefault();
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value;
  try {
    const resp = await fetch(`${API_URL}/login`, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({ username, password })
    });
    if (resp.ok) {
      const data = await resp.json();
      token = data.access_token;
      localStorage.setItem("token", token);  // Simpan token ke localStorage
      alert("Login berhasil!");
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("logoutBtn").style.display = "inline-block";
      fetchLogs();
    } else {
      alert("Login gagal. Cek username/password.");
    }
  } catch {
    alert("Kesalahan saat login.");
  }
});

// Logout handler
document.getElementById("logoutBtn").addEventListener("click", () => {
  token = null;
  localStorage.removeItem("token");  // Hapus token dari localStorage
  document.getElementById("loginForm").style.display = "flex";
  document.getElementById("logoutBtn").style.display = "none";
  allLogs = [];
  filteredLogs = [];
  activeLogId = null;
  document.getElementById("logsList").innerHTML = "Silakan login untuk melihat log privat.<br/>Memuat log publik...";
  document.getElementById("logInfo").textContent = "Pilih log untuk melihat info dan isinya.";
  document.getElementById("preview").textContent = "Pilih log untuk melihat isinya.";
  fetchLogs();
});

// Filter input event
document.getElementById("filterInput").addEventListener("input", () => {
  applyFilter();
});

window.onload = () => {
  token = localStorage.getItem("token");
  if (token) {
    document.getElementById("loginForm").style.display = "none";
    document.getElementById("logoutBtn").style.display = "inline-block";
  }
  fetchLogs();
};

// Inisialisasi halaman
fetchLogs();
</script>

</body>
</html>
